<!doctype html>

<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>عيد ميلاد أميمة 25 — احتفال ثلاثي الأبعاد</title>
  <style>
    /* Reset */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family: "Tajawal", system-ui, Arial, sans-serif;background:#0b1020;color:#fff}/* Canvas container */
#stage{position:fixed;inset:0;overflow:hidden}

/* UI overlay */
.overlay{
  position:fixed;inset:18px;display:flex;flex-direction:column;gap:12px;pointer-events:none
}
.topbar{display:flex;justify-content:space-between;align-items:center;pointer-events:auto}
.brand{background:linear-gradient(90deg,#ff9a9e,#fad0c4);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:700;font-size:18px}

.card{background:rgba(255,255,255,0.06);backdrop-filter:blur(6px);padding:12px;border-radius:12px;pointer-events:auto}

.title{font-size:20px;font-weight:800}
.subtitle{opacity:0.85;font-size:13px}

.controls{display:flex;gap:8px;align-items:center}
button{appearance:none;border:0;padding:8px 12px;border-radius:10px;background:linear-gradient(180deg,#ffd27a,#ff9a2e);color:#111;font-weight:700;cursor:pointer}
.ghost{background:rgba(255,255,255,0.08);color:#fff}

.centerText{position:absolute;left:50%;top:12%;transform:translateX(-50%);text-align:center;pointer-events:auto}
.centerText h1{font-size:36px;margin-bottom:6px}
.centerText p{opacity:0.9}

.footer{margin-top:auto;display:flex;gap:8px;align-items:center}

/* Play button big */
.playLarge{position:fixed;bottom:36px;left:50%;transform:translateX(-50%);pointer-events:auto}

/* small note for no-webgl */
#no-webgl{display:none;padding:20px;background:#111;border-radius:12px}

@media (max-width:720px){.centerText h1{font-size:24px}}

  </style>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <div id="stage"></div>  <div class="overlay">
    <div class="topbar">
      <div class="card">
        <div class="brand">🎉 احتفال أميمة - 25 سنة</div>
        <div class="subtitle">صفحة تفاعلية ثلاثية الأبعاد قابلة للتخصيص</div>
      </div><div class="controls">
    <div class="card">
      <label style="display:flex;gap:8px;align-items:center">
        <span>لون الكعكة</span>
        <input id="cakeColor" type="color" value="#ff9a9e">
      </label>
    </div>

    <div class="card">
      <button id="toggleRotate" class="ghost">إيقاف الحركة</button>
      <button id="confettiBtn">مفاجأة</button>
    </div>
  </div>
</div>

<div class="centerText">
  <h1 id="greeting">كل سنة وأنتِ طيبة يا أميمة 🎂</h1>
  <p id="sub">٢٥ سنة من الفرح — احتفلوا معنا!</p>
</div>

<div class="footer">
  <div class="card">مرّر / اسحب لتدوير المشهد • كُن لطيفاً مع الصوت</div>
</div>

  </div>  <div class="playLarge">
    <button id="playMusic">تشغيل موسيقى الاحتفال</button>
  </div>  <div id="no-webgl">متصفحك لا يدعم WebGL. يمكنك تحديث المتصفح أو فتح هذه الصفحة على متصفح حديث لعرض التجربة ثلاثية الأبعاد.</div><audio id="bgMusic" loop src="" preload="none"></audio>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.152.2/examples/jsm/controls/OrbitControls.js';
    import { FontLoader } from 'https://unpkg.com/three@0.152.2/examples/jsm/loaders/FontLoader.js';
    import { TextGeometry } from 'https://unpkg.com/three@0.152.2/examples/jsm/geometries/TextGeometry.js';

    // Basic feature detection
    if (!THREE.WEBGL.isWebGLAvailable()){
      document.getElementById('no-webgl').style.display='block';
      throw new Error('WebGL not supported');
    }

    // Scene setup
    const container = document.getElementById('stage');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x071025);

    const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 2000);
    camera.position.set(0, 6, 14);

    const renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
    renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
    renderer.setSize(innerWidth, innerHeight);
    container.appendChild(renderer.domElement);

    // Lights
    const amb = new THREE.AmbientLight(0xffffff,0.45);
    scene.add(amb);
    const dir = new THREE.DirectionalLight(0xffffff,0.6);
    dir.position.set(5,10,7); scene.add(dir);

    // Floor reflection plane
    const floorGeo = new THREE.PlaneGeometry(60,60);
    const floorMat = new THREE.MeshStandardMaterial({color:0x06060b,roughness:0.7,metalness:0.0});
    const floor = new THREE.Mesh(floorGeo,floorMat); floor.rotation.x = -Math.PI/2; floor.position.y = -1.8; scene.add(floor);

    // Cake group
    const cake = new THREE.Group();

    function makeTier(radius,height,color,y){
      const geo = new THREE.CylinderGeometry(radius, radius, height, 64);
      const mat = new THREE.MeshStandardMaterial({color,roughness:0.5,metalness:0.05});
      const mesh = new THREE.Mesh(geo,mat); mesh.position.y = y; return mesh;
    }

    // default colors
    let cakeColor = 0xff9a9e;

    const tier1 = makeTier(3.6,1.4,cakeColor,0.0);
    const tier2 = makeTier(2.6,1.2,0xffffff,1.3);
    const tier3 = makeTier(1.6,0.9,cakeColor,2.3);
    cake.add(tier1,tier2,tier3);

    // icing as rings (thin torus)
    const icingTop = new THREE.TorusGeometry(1.7,0.18,16,100);
    const icingMat = new THREE.MeshStandardMaterial({color:0xfff3e0,roughness:0.35});
    const icing = new THREE.Mesh(icingTop,icingMat); icing.rotation.x = Math.PI/2; icing.position.y = 2.75; cake.add(icing);

    // candles
    const candles = new THREE.Group();
    const candleGeom = new THREE.CylinderGeometry(0.08,0.08,0.6,16);
    const candleMat = new THREE.MeshStandardMaterial({color:0xffffff,metalness:0.1,roughness:0.6});

    const flameGeom = new THREE.SphereGeometry(0.12,12,8);
    const flameMat = new THREE.MeshBasicMaterial({color:0xffcc33});

    const candlePositions = [-1.4,-0.7,0,0.7,1.4];
    candlePositions.forEach((x,i)=>{
      const c = new THREE.Mesh(candleGeom,candleMat);
      c.position.set(x,3.05,0.6*Math.sin(i));
      c.rotation.z = (Math.random()-0.5)*0.1;
      const flame = new THREE.Mesh(flameGeom,flameMat);
      flame.position.set(0,0.38,0); flame.scale.setScalar(1.0+Math.random()*0.2);
      const light = new THREE.PointLight(0xffc87c,0.6,6,2);
      light.position.set(c.position.x,c.position.y+0.35,c.position.z);
      c.add(flame);
      candles.add(c);
      candles.add(light);
    });
    cake.add(candles);

    // 3D number "25" using FontLoader
    const loader = new FontLoader();
    loader.load('https://unpkg.com/three@0.152.2/examples/fonts/helvetiker_regular.typeface.json', (font)=>{
      const txtGeo = new TextGeometry('٢٥',{
        font:font, size:0.9, height:0.18, curveSegments:12, bevelEnabled:true, bevelThickness:0.02, bevelSize:0.02
      });
      txtGeo.computeBoundingBox();
      const txtMat = new THREE.MeshStandardMaterial({color:0xffe08a,metalness:0.3,roughness:0.4});
      const txt = new THREE.Mesh(txtGeo,txtMat);
      const box = txtGeo.boundingBox;
      const xOffset = -0.5*(box.max.x - box.min.x);
      txt.position.set(xOffset,3.6,0);
      txt.rotation.y = -0.1;
      cake.add(txt);
    });

    // Add cake to scene
    cake.position.y = -0.2;
    scene.add(cake);

    // Particles (soft floating lights)
    const partCount = 160;
    const partGeo = new THREE.BufferGeometry();
    const pos = new Float32Array(partCount*3);
    for(let i=0;i<partCount;i++){
      pos[i*3+0] = (Math.random()-0.5)*18;
      pos[i*3+1] = Math.random()*8 - 1;
      pos[i*3+2] = (Math.random()-0.5)*18;
    }
    partGeo.setAttribute('position', new THREE.BufferAttribute(pos,3));
    const partMat = new THREE.PointsMaterial({size:0.05,transparent:true,opacity:0.9});
    const particles = new THREE.Points(partGeo,partMat); scene.add(particles);

    // Controls
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.enablePan = false; controls.minDistance = 6; controls.maxDistance = 30; controls.maxPolarAngle = Math.PI/2.1;

    // Animation
    let rotating = true;
    const clock = new THREE.Clock();

    function animate(){
      const t = clock.getElapsedTime();
      if(rotating) cake.rotation.y = t*0.25;
      particles.rotation.y = -t*0.02;

      // candle flame flicker: scale and light intensity
      candles.children.forEach((child)=>{
        if(child.type === 'Mesh' && child.geometry.type === 'SphereGeometry'){
          const s = 1 + Math.sin(t*10 + Math.random()*3)*0.06;
          child.scale.setScalar(s);
        }
        if(child.type === 'PointLight'){
          child.intensity = 0.5 + Math.sin(t*8 + Math.random()*5)*0.2;
        }
      });

      controls.update();
      renderer.render(scene,camera);
      requestAnimationFrame(animate);
    }
    animate();

    // Resize
    window.addEventListener('resize', ()=>{
      camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight);
    });

    // UI interactions
    const cakeColorInput = document.getElementById('cakeColor');
    cakeColorInput.addEventListener('input', (e)=>{
      cakeColor = new THREE.Color(e.target.value).getHex();
      tier1.material.color.setHex(cakeColor);
      tier3.material.color.setHex(cakeColor);
    });

    document.getElementById('toggleRotate').addEventListener('click', (e)=>{
      rotating = !rotating; e.target.textContent = rotating ? 'إيقاف الحركة' : 'تشغيل الحركة';
    });

    // Confetti simple implementation: spawn DOM confetti elements
    document.getElementById('confettiBtn').addEventListener('click', ()=>{
      launchConfetti();
    });

    function launchConfetti(){
      const count = 60;
      for(let i=0;i<count;i++){
        const el = document.createElement('div');
        el.style.position='fixed'; el.style.width='10px'; el.style.height='14px';
        el.style.left = (50 + (Math.random()-0.5)*60) + '%';
        el.style.top = (0 + Math.random()*30) + '%';
        el.style.background = `hsl(${Math.random()*360},85%,60%)`;
        el.style.opacity='0.95'; el.style.borderRadius='2px'; el.style.pointerEvents='none';
        el.style.transform = `translateY(0) rotate(${Math.random()*360}deg)`;
        el.style.transition = `transform 2.6s cubic-bezier(.2,.8,.2,1), opacity 2.6s`;
        document.body.appendChild(el);
        requestAnimationFrame(()=>{
          el.style.transform = `translateY(120vh) rotate(${Math.random()*1080}deg)`;
          el.style.opacity='0';
        });
        setTimeout(()=>el.remove(),3000+Math.random()*800);
      }
    }

    // Music
    const bg = document.getElementById('bgMusic');
    const playBtn = document.getElementById('playMusic');
    // default celebratory track (royalty-free short melody hosted as data URI placeholder)
    // You can replace src with a URL to an mp3 file. Autoplay blocked on many browsers — user must press.
    bg.src = 'https://cdn.jsdelivr.net/gh/anars/blank-audio@master/2sec.mp3';
    playBtn.addEventListener('click', async ()=>{
      try{ await bg.play(); playBtn.textContent='إيقاف الموسيقى'; playBtn.onclick = ()=>{ bg.pause(); playBtn.textContent='تشغيل موسيقى الاحتفال'; }}catch(e){ alert('المتصفح منع التشغيل التلقائي. اضغط تشغيل مرة أخرى.'); }
    });

    // Personalization: change greeting
    const greeting = document.getElementById('greeting');
    greeting.addEventListener('dblclick', ()=>{
      const name = prompt('أدخل اسم الشخص (مثلاً: أميمة)',['أميمة']);
      if(name) greeting.textContent = `كل سنة وأنتِ طيبة يا ${name} 🎂`;
    });

    // Small accessibility: keyboard toggle rotation with space
    window.addEventListener('keydown',(e)=>{ if(e.code==='Space'){ e.preventDefault(); rotating=!rotating; document.getElementById('toggleRotate').textContent = rotating ? 'إيقاف الحركة' : 'تشغيل الحركة'; } });

    // Helper: let user download a PNG snapshot
    function downloadSnapshot(){
      renderer.domElement.toBlob(blob=>{
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download = 'oumima-25.png'; a.click(); URL.revokeObjectURL(url);
      });
    }

    // Add context menu quick actions
    window.addEventListener('contextmenu', (e)=>{
      e.preventDefault();
      const action = confirm('نسخة صورة للتهنئة؟ اضغط موافق لحفظ لقطة الشاشة.');
      if(action) downloadSnapshot();
    });

    // Optional: let user customize default text or cake details by URL params
    const params = new URLSearchParams(location.search);
    if(params.get('name')) greeting.textContent = `كل سنة وأنتِ طيبة يا ${params.get('name')} 🎂`;
    if(params.get('age')) document.getElementById('sub').textContent = `${params.get('age')} سنة من الفرح — احتفلوا معنا!`;

    // Small polish: gentle camera intro animation
    const startTime = performance.now();
    const startPos = {z:18,y:10};
    function intro(){
      const now = performance.now(); const p = Math.min((now-startTime)/1100,1);
      camera.position.z = startPos.z - (startPos.z - 14)*(p);
      camera.position.y = startPos.y - (startPos.y - 6)*(p);
      if(p<1) requestAnimationFrame(intro);
    }
    intro();

  </script>  <!-- Notes for editing: double-click greeting to edit text, use color input to change cake color, right-click to save snapshot --></body>
</html>